.PHONY: editor run

ifndef PROJECT_ROOT
$(error Running not from root makefile)
endif

ifndef IGNITE_ENGINE_LIB
$(error Can't find `IGNITE_ENGINE_LIB` definition)
endif

unexport THIS_MAKE_FILE     := $(abspath $(lastword $(MAKEFILE_LIST)))
unexport THIS_MAKE_FILE_DIR := $(realpath $(patsubst %/,%,$(dir $(THIS_MAKE_FILE))))

IGNITE_EDITOR_DIR  := $(THIS_MAKE_FILE_DIR)
IGNITE_EDITOR_NAME := ignite
IGNITE_EDITOR      := $(PROJECT_BUILD_DIR)/$(IGNITE_EDITOR_NAME)

IGNITE_EDITOR_INCLUDE_DIR := $(IGNITE_EDITOR_DIR)/include
IGNITE_EDITOR_SOURCES_DIR := $(IGNITE_EDITOR_DIR)/src
IGNITE_EDITOR_TESTS_DIR   := $(IGNITE_EDITOR_DIR)/tests

IGNITE_EDITOR_SOURCES := $(wildcard $(IGNITE_EDITOR_SOURCES_DIR)/*.c)
IGNITE_EDITOR_HEADERS := $(wildcard $(IGNITE_EDITOR_INCLUDE_DIR)/**/*.h)
IGNITE_EDITOR_OBJS    := $(patsubst $(IGNITE_EDITOR_SOURCES_DIR)/%.c, $(PROJECT_OBJ_DIR)/%.o, $(IGNITE_EDITOR_SOURCES))

IGNITE_EDITOR_TESTS_SOURCES := $(wildcard $(IGNITE_EDITOR_TESTS_DIR)/*.c)
IGNITE_EDITOR_TESTS_EXECS   := $(patsubst $(IGNITE_EDITOR_TESTS_DIR)/%.c, $(PROJECT_TESTS_EXEC_DIR)/%, $(IGNITE_EDITOR_TESTS_SOURCES))

PROJECT_INCLUDE_FLAGS := $(PROJECT_INCLUDE_FLAGS) -I$(IGNITE_EDITOR_INCLUDE_DIR)
PROJECT_SOURCES       := $(PROJECT_SOURCES) $(IGNITE_EDITOR_SOURCES)
PROJECT_HEADERS       := $(PROJECT_HEADERS) $(IGNITE_EDITOR_HEADERS)
PROJECT_TESTS_EXECS   := $(PROJECT_TESTS_EXECS) $(IGNITE_EDITOR_TESTS_EXECS)
PROJECT_TARGETS       := $(PROJECT_IGNITE_EDITORS) $(IGNITE_EDITOR)

editor: $(IGNITE_EDITOR)

$(IGNITE_EDITOR): $(IGNITE_EDITOR_OBJS) $(IGNITE_ENGINE_LIB)
	$(RM) $@
	$(CC) $(CFLAGS) $(CFLAGS_SECURE) $^ -o $@

$(PROJECT_OBJ_DIR)/%.o: $(IGNITE_EDITOR_SOURCES_DIR)/%.c $(IGNITE_EDITOR_INCLUDE_DIR)/$(PROJECT_NAME)/%.h
	$(CC) $(CFLAGS) $(CFLAGS_SECURE) -c $< -o $@ $(PROJECT_INCLUDE_FLAGS)

$(PROJECT_OBJ_DIR)/%.o: $(IGNITE_EDITOR_SOURCES_DIR)/%.c
	$(CC) $(CFLAGS) $(CFLAGS_SECURE) -c $< -o $@ $(PROJECT_INCLUDE_FLAGS)

$(PROJECT_TESTS_EXEC_DIR)/%: $(IGNITE_EDITOR_OBJS) $(IGNITE_EDITOR_TESTS_DIR)/%.c
	$(CC) $(CFLAGS) $^ -o $@ -lcriterion $(PROJECT_INCLUDE_FLAGS)

run: $(IGNITE_EDITOR)
	$<
