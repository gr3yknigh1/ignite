.PHONY: engine

ifndef PROJECT_ROOT
$(error Running not from root makefile)
endif

unexport THIS_MAKE_FILE     := $(abspath $(lastword $(MAKEFILE_LIST)))
unexport THIS_MAKE_FILE_DIR := $(realpath $(patsubst %/,%,$(dir $(THIS_MAKE_FILE))))

IGNITE_ENGINE_DIR      := $(THIS_MAKE_FILE_DIR)
IGNITE_ENGINE_LIB_NAME := libignite.a
IGNITE_ENGINE_LIB      := $(PROJECT_BUILD_DIR)/$(IGNITE_ENGINE_LIB_NAME)

IGNITE_ENGINE_INCLUDE_DIR := $(IGNITE_ENGINE_DIR)/include
IGNITE_ENGINE_SOURCES_DIR := $(IGNITE_ENGINE_DIR)/src
IGNITE_ENGINE_TESTS_DIR   := $(IGNITE_ENGINE_DIR)/tests

IGNITE_ENGINE_SOURCES := $(wildcard $(IGNITE_ENGINE_SOURCES_DIR)/*.c)
IGNITE_ENGINE_HEADERS := $(wildcard $(IGNITE_ENGINE_INCLUDE_DIR)/**/*.h)
IGNITE_ENGINE_OBJS    := $(patsubst $(IGNITE_ENGINE_SOURCES_DIR)/%.c, $(PROJECT_OBJ_DIR)/%.o, $(IGNITE_ENGINE_SOURCES))

IGNITE_ENGINE_TESTS_SOURCES := $(wildcard $(IGNITE_ENGINE_TESTS_DIR)/*.c)
IGNITE_ENGINE_TESTS_EXECS   := $(patsubst $(IGNITE_ENGINE_TESTS_DIR)/%.c, $(PROJECT_TESTS_EXEC_DIR)/%, $(IGNITE_ENGINE_TESTS_SOURCES))

IGNITE_ENGINE_INCLUDE_FLAGS := -I$(IGNITE_ENGINE_INCLUDE_DIR) -I$(GLAD_INCLUDE_DIR)

PROJECT_SOURCES       += $(IGNITE_ENGINE_SOURCES)
PROJECT_HEADERS       += $(IGNITE_ENGINE_HEADERS)
PROJECT_TESTS_SOURCES += $(IGNITE_ENGINE_TESTS_SOURCES)

PROJECT_TARGETS     += $(IGNITE_ENGINE_LIB)
PROJECT_OBJS        += $(IGNITE_ENGINE_OBJS)
PROJECT_TESTS_EXECS += $(IGNITE_ENGINE_TESTS_EXECS)

engine: dirs $(IGNITE_ENGINE_LIB)

$(IGNITE_ENGINE_LIB): $(IGNITE_ENGINE_OBJS) $(GLAD_LIB)
	$(RM) $@
	$(AR) $(ARFLAGS) $@ $^

$(PROJECT_OBJ_DIR)/%.o: $(IGNITE_ENGINE_SOURCES_DIR)/%.c $(IGNITE_ENGINE_INCLUDE_DIR)/$(PROJECT_NAME)/%.h
	$(CC) $(CFLAGS) $(CFLAGS_SECURE) -c $< -o $@ $(IGNITE_ENGINE_INCLUDE_FLAGS)

$(PROJECT_OBJ_DIR)/%.o: $(IGNITE_ENGINE_SOURCES_DIR)/%.c
	$(CC) $(CFLAGS) $(CFLAGS_SECURE) -c $< -o $@ $(IGNITE_ENGINE_INCLUDE_FLAGS)

$(PROJECT_TESTS_EXEC_DIR)/%: $(IGNITE_ENGINE_OBJS) $(IGNITE_ENGINE_TESTS_DIR)/%.c
	$(CC) $(CFLAGS) $^ -o $@ -lcriterion $(IGNITE_ENGINE_INCLUDE_FLAGS)

